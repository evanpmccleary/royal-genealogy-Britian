<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>William I Family Demo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f7f3e8;
      overflow: hidden;
    }

    #chart-container {
      width: 100vw;
      height: 100vh;
    }

    .node-rect {
      fill: #ffffff;
      stroke: #333333;
      stroke-width: 1.5px;
      rx: 6px;
      ry: 6px;
      cursor: pointer;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }

    .node-text {
      font-size: 12px;
      text-anchor: middle;
      dominant-baseline: middle;
      pointer-events: none;
      fill: #222222;
    }

    .link-parent {
      stroke: #1e4fa8;
      stroke-width: 2px;
      fill: none;
    }

    .link-marriage {
      stroke: #1e4fa8;
      stroke-width: 2px;
      stroke-dasharray: 4 4;
      fill: none;
    }

    /* Person card popup */
    #person-card {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      max-width: 420px;
      max-height: 80vh;
      overflow-y: auto;
      background: #ffffff;
      border-radius: 10px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.25);
      padding: 16px 18px;
      z-index: 1000;
      display: none;
    }

    #person-card h2 {
      margin: 0 0 8px 0;
      font-size: 18px;
    }

    #person-card .label {
      font-weight: 600;
    }

    #person-card .value {
      margin-bottom: 6px;
    }

    #person-card .close-btn {
      position: absolute;
      top: 8px;
      right: 10px;
      background: transparent;
      border: none;
      font-size: 18px;
      cursor: pointer;
    }

    #overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.3);
      display: none;
      z-index: 900;
    }

    a {
      color: #1e4fa8;
    }

    a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <div id="chart-container"></div>
  <div id="overlay"></div>
  <div id="person-card">
    <button class="close-btn" aria-label="Close">&times;</button>
    <div id="person-card-content"></div>
  </div>

  <!-- D3.js -->
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script>
    // ---- DATA -------------------------------------------------------------------

    // Basic person data for card popup
    const people = {
      // Top generation
      william1: {
        id: "william1",
        name: "William I",
        nicknames: [
          "William the Conqueror",
          "William the Bastard",
          "William I of England",
          "Duke William II of Normandy",
          "Guillaume le Conquérant",
          "William of Normandy"
        ],
        birth: "c. 1028",
        death: "9 September 1087",
        parents: ["Robert I of Normandy", "Herleva"],
        spouses: ["Matilda of Flanders"],
        children: [
          "Robert Curthose",
          "Richard",
          "William II",
          "Henry I",
          "Cecilia",
          "Adeliza",
          "Matilda",
          "Constance",
          "Adela",
          "Agatha"
        ],
        titles: [
          "King of England (1066–1087)",
          "Duke of Normandy (1035–1087)"
        ],
        house: "Normandy",
        bio: "William I conquered England in 1066 and established Norman rule, reshaping English governance and landholding.",
        wikipedia: "https://en.wikipedia.org/wiki/William_the_Conqueror",
        certainty: 1
      },
      matildaFlanders: {
        id: "matildaFlanders",
        name: "Matilda of Flanders",
        nicknames: [],
        birth: "c. 1031",
        death: "2 November 1083",
        parents: ["Baldwin V, Count of Flanders", "Adela of France"],
        spouses: ["William I"],
        children: [
          "Robert Curthose",
          "Richard",
          "William II",
          "Henry I",
          "Cecilia",
          "Adeliza",
          "Matilda",
          "Constance",
          "Adela",
          "Agatha"
        ],
        titles: ["Queen consort of England"],
        house: "Flanders",
        bio: "Matilda of Flanders was queen consort of England as the wife of William I and played a key political role in Normandy and England.",
        wikipedia: "https://en.wikipedia.org/wiki/Matilda_of_Flanders",
        certainty: 1
      },

      // Children
      robert: {
        id: "robert",
        name: "Robert Curthose",
        nicknames: [],
        birth: "c. 1050",
        death: "3 February 1134",
        parents: ["William I", "Matilda of Flanders"],
        spouses: ["Sibylla of Conversano"],
        children: [],
        titles: ["Duke of Normandy (1087–1106)"],
        house: "Normandy",
        bio: "Robert Curthose was the eldest son of William I and duke of Normandy.",
        wikipedia: "https://en.wikipedia.org/wiki/Robert_Curthose",
        certainty: 1
      },
      richard: {
        id: "richard",
        name: "Richard",
        nicknames: [],
        birth: "c. 1055?",
        death: "c. 1075?",
        parents: ["William I", "Matilda of Flanders"],
        spouses: [],
        children: [],
        titles: [],
        house: "Normandy",
        bio: "Richard was a son of William I who died young in a hunting accident.",
        wikipedia: "https://en.wikipedia.org/wiki/William_the_Conqueror#Family",
        certainty: 2
      },
      william2: {
        id: "william2",
        name: "William II",
        nicknames: ["William Rufus"],
        birth: "c. 1056",
        death: "2 August 1100",
        parents: ["William I", "Matilda of Flanders"],
        spouses: [],
        children: [],
        titles: ["King of England (1087–1100)"],
        house: "Normandy",
        bio: "William II, called Rufus, was king of England after William I and died in a mysterious hunting accident.",
        wikipedia: "https://en.wikipedia.org/wiki/William_II_of_England",
        certainty: 1
      },
      henry1: {
        id: "henry1",
        name: "Henry I",
        nicknames: ["Henry Beauclerc"],
        birth: "c. 1068",
        death: "1 December 1135",
        parents: ["William I", "Matilda of Flanders"],
        spouses: ["Matilda of Scotland", "Adeliza of Louvain"],
        children: [],
        titles: ["King of England (1100–1135)", "Duke of Normandy (1106–1135)"],
        house: "Normandy",
        bio: "Henry I was the youngest son of William I and ruled England and Normandy, noted for administrative reforms.",
        wikipedia: "https://en.wikipedia.org/wiki/Henry_I_of_England",
        certainty: 1
      },
      cecilia: {
        id: "cecilia",
        name: "Cecilia",
        nicknames: [],
        birth: "c. 1056",
        death: "13 July 1126",
        parents: ["William I", "Matilda of Flanders"],
        spouses: [],
        children: [],
        titles: [],
        house: "Normandy",
        bio: "Cecilia was a daughter of William I who became a nun and abbess at Caen.",
        wikipedia: "https://en.wikipedia.org/wiki/Cecilia_of_Normandy",
        certainty: 1
      },
      adelizaDaughter: {
        id: "adelizaDaughter",
        name: "Adeliza (Adelaide)",
        nicknames: ["Adelaide of Normandy"],
        birth: "c. 1050–1052",
        death: "c. 1120",
        parents: ["William I", "Matilda of Flanders"],
        spouses: ["Stephen, Count of Aumale"],
        children: [],
        titles: [],
        house: "Normandy",
        bio: "Adelaide of Normandy, sometimes called Adeliza, was a daughter of William I and wife of Stephen, Count of Aumale.",
        wikipedia: "https://en.wikipedia.org/wiki/Adelaide_of_Normandy",
        certainty: 2
      },
      matildaDaughter: {
        id: "matildaDaughter",
        name: "Matilda",
        nicknames: [],
        birth: "unknown",
        death: "before 1113?",
        parents: ["William I", "Matilda of Flanders"],
        spouses: [],
        children: [],
        titles: [],
        house: "Normandy",
        bio: "Matilda was a daughter of William I; little is known and she likely died unmarried.",
        wikipedia: "https://en.wikipedia.org/wiki/William_the_Conqueror#Family",
        certainty: 3
      },
      constance: {
        id: "constance",
        name: "Constance",
        nicknames: [],
        birth: "c. 1061",
        death: "13 August 1090",
        parents: ["William I", "Matilda of Flanders"],
        spouses: ["Alan IV, Duke of Brittany"],
        children: [],
        titles: [],
        house: "Normandy",
        bio: "Constance was a daughter of William I and wife of Alan IV, duke of Brittany.",
        wikipedia: "https://en.wikipedia.org/wiki/Constance_of_Normandy",
        certainty: 1
      },
      adelaDaughter: {
        id: "adelaDaughter",
        name: "Adela",
        nicknames: ["Adela of Normandy"],
        birth: "c. 1067",
        death: "8 March 1137",
        parents: ["William I", "Matilda of Flanders"],
        spouses: ["Stephen, Count of Blois"],
        children: [],
        titles: [],
        house: "Normandy",
        bio: "Adela of Normandy was a daughter of William I and mother of King Stephen of England.",
        wikipedia: "https://en.wikipedia.org/wiki/Adela_of_Normandy",
        certainty: 1
      },
      agatha: {
        id: "agatha",
        name: "Agatha",
        nicknames: [],
        birth: "c. 1064?",
        death: "c. 1080?",
        parents: ["William I", "Matilda of Flanders"],
        spouses: [],
        children: [],
        titles: [],
        house: "Normandy",
        bio: "Agatha was a daughter of William I, reportedly betrothed to several princes but died young.",
        wikipedia: "https://en.wikipedia.org/wiki/William_the_Conqueror#Family",
        certainty: 3
      },

      // Spouses of children
      sibylla: {
        id: "sibylla",
        name: "Sibylla of Conversano",
        nicknames: [],
        birth: "c. 1080s",
        death: "March 1103",
        parents: [],
        spouses: ["Robert Curthose"],
        children: [],
        titles: [],
        house: "Conversano",
        bio: "Sibylla of Conversano was the wife of Robert Curthose, duke of Normandy.",
        wikipedia: "https://en.wikipedia.org/wiki/Sibylla_of_Conversano",
        certainty: 2
      },
      matildaScot: {
        id: "matildaScot",
        name: "Matilda of Scotland",
        nicknames: [],
        birth: "1080",
        death: "1 May 1118",
        parents: [],
        spouses: ["Henry I"],
        children: [],
        titles: ["Queen consort of England"],
        house: "Dunkeld",
        bio: "Matilda of Scotland was the first wife of Henry I and queen consort of England.",
        wikipedia: "https://en.wikipedia.org/wiki/Matilda_of_Scotland",
        certainty: 1
      },
      adelizaLouvain: {
        id: "adelizaLouvain",
        name: "Adeliza of Louvain",
        nicknames: [],
        birth: "c. 1103",
        death: "23 April 1151",
        parents: [],
        spouses: ["Henry I"],
        children: [],
        titles: ["Queen consort of England"],
        house: "House of Reginar",
        bio: "Adeliza of Louvain was the second wife of Henry I and queen consort of England.",
        wikipedia: "https://en.wikipedia.org/wiki/Adeliza_of_Louvain",
        certainty: 1
      },
      stephenAumale: {
        id: "stephenAumale",
        name: "Stephen, Count of Aumale",
        nicknames: [],
        birth: "c. 1070",
        death: "c. 1127",
        parents: [],
        spouses: ["Adeliza (Adelaide)"],
        children: [],
        titles: ["Count of Aumale"],
        house: "Blois-Aumale",
        bio: "Stephen of Aumale was a Norman noble and husband of Adelaide/Adeliza of Normandy.",
        wikipedia: "https://en.wikipedia.org/wiki/Stephen,_Count_of_Aumale",
        certainty: 2
      },
      alanIV: {
        id: "alanIV",
        name: "Alan IV, Duke of Brittany",
        nicknames: ["Alan Fergant"],
        birth: "c. 1060",
        death: "13 October 1119",
        parents: [],
        spouses: ["Constance"],
        children: [],
        titles: ["Duke of Brittany"],
        house: "House of Rennes",
        bio: "Alan IV, called Fergant, was duke of Brittany and husband of Constance of Normandy.",
        wikipedia: "https://en.wikipedia.org/wiki/Alan_IV,_Duke_of_Brittany",
        certainty: 1
      },
      stephenBlois: {
        id: "stephenBlois",
        name: "Stephen, Count of Blois",
        nicknames: [],
        birth: "c. 1045",
        death: "19 May 1102",
        parents: [],
        spouses: ["Adela"],
        children: [],
        titles: ["Count of Blois"],
        house: "Blois",
        bio: "Stephen, count of Blois, was a crusader and husband of Adela of Normandy.",
        wikipedia: "https://en.wikipedia.org/wiki/Stephen_II,_Count_of_Blois",
        certainty: 1
      }
    };

    // Nodes for chart with positions (we'll manually position for this small demo)
    const nodeWidth = 120;
    const nodeHeight = 38;
    const verticalGap = 110;
    const horizontalGap = 130;

    // Define children in order for layout
    const childrenOrder = [
      "robert",
      "richard",
      "william2",
      "henry1",
      "cecilia",
      "adelizaDaughter",
      "matildaDaughter",
      "constance",
      "adelaDaughter",
      "agatha"
    ];

    const startX = 80;
    const topY = 80;
    const childrenY = topY + verticalGap;

    const nodes = [];

    // Create child nodes with x positions
    childrenOrder.forEach((id, index) => {
      const x = startX + index * horizontalGap;
      nodes.push({
        id,
        data: people[id],
        x,
        y: childrenY
      });
    });

    // Compute center X of children row
    const minX = nodes[0].x;
    const maxX = nodes[nodes.length - 1].x;
    const centerX = (minX + maxX) / 2;

    // William and Matilda
    nodes.push({
      id: "william1",
      data: people.william1,
      x: centerX - nodeWidth,
      y: topY
    });
    nodes.push({
      id: "matildaFlanders",
      data: people.matildaFlanders,
      x: centerX + nodeWidth,
      y: topY
    });

    // Spouses for children (same Y as children, to the right of each)
    function addSpouseNode(childId, spouseKey, offset = 70) {
      const childNode = nodes.find(n => n.id === childId);
      if (!childNode) return;
      const spouse = people[spouseKey];
      nodes.push({
        id: spouse.id,
        data: spouse,
        x: childNode.x + offset,
        y: childNode.y
      });
    }

    addSpouseNode("robert", "sibylla");
    addSpouseNode("henry1", "matildaScot");
    addSpouseNode("henry1", "adelizaLouvain", 210); // second wife a bit further
    addSpouseNode("adelizaDaughter", "stephenAumale");
    addSpouseNode("constance", "alanIV");
    addSpouseNode("adelaDaughter", "stephenBlois");

    // Build links
    const linksParent = [];
    const linksMarriage = [];

    // Marriage between William and Matilda (dotted)
    linksMarriage.push({
      source: "william1",
      target: "matildaFlanders"
    });

    // Parent-child links from midpoint between William and Matilda down to each child
    const williamNode = nodes.find(n => n.id === "william1");
    const matildaNode = nodes.find(n => n.id === "matildaFlanders");
    const marriageMid = {
      x: (williamNode.x + matildaNode.x + nodeWidth) / 2,
      y: williamNode.y + nodeHeight / 2
    };

    childrenOrder.forEach(id => {
      const childNode = nodes.find(n => n.id === id);
      linksParent.push({
        mid: marriageMid,
        target: childNode
      });
    });

    // Dotted marriage links for children + their spouses
    function addMarriageLink(childId, spouseKey) {
      const childNode = nodes.find(n => n.id === childId);
      const spouseNode = nodes.find(n => n.id === people[spouseKey].id);
      if (!childNode || !spouseNode) return;
      linksMarriage.push({
        source: childNode.id,
        target: spouseNode.id
      });
    }

    addMarriageLink("robert", "sibylla");
    addMarriageLink("henry1", "matildaScot");
    addMarriageLink("henry1", "adelizaLouvain");
    addMarriageLink("adelizaDaughter", "stephenAumale");
    addMarriageLink("constance", "alanIV");
    addMarriageLink("adelaDaughter", "stephenBlois");

    // ---- D3 RENDERING -----------------------------------------------------------

    const container = document.getElementById("chart-container");
    const width = container.clientWidth;
    const height = container.clientHeight;

    const svg = d3.select("#chart-container")
      .append("svg")
      .attr("width", width)
      .attr("height", height);

    const g = svg.append("g");

    // Zoom & pan
    const zoom = d3.zoom()
      .scaleExtent([0.5, 2.5])
      .on("zoom", (event) => {
        g.attr("transform", event.transform);
      });

    svg.call(zoom);

    // Draw parent-child links (solid blue)
    g.selectAll(".link-parent")
      .data(linksParent)
      .enter()
      .append("path")
      .attr("class", "link-parent")
      .attr("d", d => {
        const x1 = d.mid.x;
        const y1 = d.mid.y + 10;
        const x2 = d.target.x + nodeWidth / 2;
        const y2 = d.target.y - nodeHeight / 2;
        // vertical then horizontal (orthogonal-ish)
        const midY = (y1 + y2) / 2;
        return `M${x1},${y1} L${x1},${midY} L${x2},${midY} L${x2},${y2}`;
      });

    // Draw marriage links (dotted blue)
    g.selectAll(".link-marriage")
      .data(linksMarriage)
      .enter()
      .append("line")
      .attr("class", "link-marriage")
      .attr("x1", d => {
        const n = nodes.find(n => n.id === d.source);
        return n.x + nodeWidth;
      })
      .attr("y1", d => {
        const n = nodes.find(n => n.id === d.source);
        return n.y + nodeHeight / 2;
      })
      .attr("x2", d => {
        const n = nodes.find(n => n.id === d.target);
        return n.x;
      })
      .attr("y2", d => {
        const n = nodes.find(n => n.id === d.target);
        return n.y + nodeHeight / 2;
      });

    // Draw nodes (rect + text)
    const nodeGroup = g.selectAll(".node")
      .data(nodes)
      .enter()
      .append("g")
      .attr("class", "node")
      .attr("transform", d => `translate(${d.x},${d.y})`)
      .on("click", (event, d) => {
        showPersonCard(d.data);
      });

    nodeGroup.append("rect")
      .attr("class", "node-rect")
      .attr("width", nodeWidth)
      .attr("height", nodeHeight);

    nodeGroup.append("text")
      .attr("class", "node-text")
      .attr("x", nodeWidth / 2)
      .attr("y", nodeHeight / 2)
      .text(d => d.data.name);

    // ---- PERSON CARD LOGIC ------------------------------------------------------

    const overlay = document.getElementById("overlay");
    const card = document.getElementById("person-card");
    const cardContent = document.getElementById("person-card-content");
    const cardClose = card.querySelector(".close-btn");

    function escapeHtml(str) {
      return String(str || "").replace(/[&<>"']/g, s => ({
        "&": "&amp;",
        "<": "&lt;",
        ">": "&gt;",
        '"': "&quot;",
        "'": "&#39;"
      }[s]));
    }

    function formatList(list) {
      if (!list || !list.length) return "None recorded";
      return list.join(", ");
    }

    function showPersonCard(person) {
      const nick = person.nicknames && person.nicknames.length
        ? person.nicknames.join(", ")
        : "None recorded";
      const parents = person.parents && person.parents.length
        ? person.parents.join(", ")
        : "Unknown";
      const spouses = formatList(person.spouses);
      const children = formatList(person.children);
      const titles = formatList(person.titles);

      const certaintyMap = {
        1: "1 (Confirmed)",
        2: "2 (Uncertain)",
        3: "3 (Speculative)"
      };

      const html = `
        <h2>${escapeHtml(person.name)}</h2>

        <div class="value"><span class="label">Nicknames:</span> ${escapeHtml(nick)}</div>
        <div class="value"><span class="label">Birth:</span> ${escapeHtml(person.birth || "Unknown")}</div>
        <div class="value"><span class="label">Death:</span> ${escapeHtml(person.death || "Unknown")}</div>
        <div class="value"><span class="label">Parents:</span> ${escapeHtml(parents)}</div>
        <div class="value"><span class="label">Spouses:</span> ${escapeHtml(spouses)}</div>
        <div class="value"><span class="label">Children:</span> ${escapeHtml(children)}</div>
        <div class="value"><span class="label">Titles:</span> ${escapeHtml(titles)}</div>
        <div class="value"><span class="label">House:</span> ${escapeHtml(person.house || "Unknown")}</div>
        <div class="value"><span class="label">Bio:</span><br>${escapeHtml(person.bio || "No bio yet.")}</div>
        <div class="value"><span class="label">Wikipedia:</span> ${
          person.wikipedia
            ? '<a href="' + escapeHtml(person.wikipedia) + '" target="_blank" rel="noopener">Open article</a>'
            : "None"
        }</div>
        <div class="value"><span class="label">Certainty Score:</span> ${escapeHtml(certaintyMap[person.certainty] || String(person.certainty || ""))}</div>
      `;

      cardContent.innerHTML = html;
      overlay.style.display = "block";
      card.style.display = "block";
    }

    function hidePersonCard() {
      overlay.style.display = "none";
      card.style.display = "none";
    }

    overlay.addEventListener("click", hidePersonCard);
    cardClose.addEventListener("click", hidePersonCard);
  </script>
</body>
</html>
